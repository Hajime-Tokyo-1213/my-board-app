## 改修仕様書 0813_2（ログイン/ログアウト機能の不足分）

### 目的
ログイン/ログアウト機能の現状を整理し、不足分（要件との差分）を補完する。

### 対象範囲（スコープ）
- 画面: ログインページ、ヘッダー（ログイン状態表示/ログアウト）
- 認証: NextAuth 設定、セッション管理、リダイレクト
- 補助: 未ログイン時の表示切り替え（保護ページへの誘導）

### 現状の実装（確認済み）
- ログイン（メール/パスワード）
  - `app/auth/signin/page.tsx` で `signIn('credentials', { redirect: false })` により実装済み
  - `lib/auth.ts` の CredentialsProvider でメール/パスワード検証、日本語メッセージ、未確認メールの拒否
- ログイン状態の表示（ヘッダー）
  - `components/Header.tsx` で `useSession()` により状態切替（ユーザー名表示/ログイン・新規登録ボタン）
- ログアウト機能
  - ヘッダーの「ログアウト」で `signOut({ redirect: false })` 実行後、`/auth/signin` へ遷移
- セッション管理
  - `app/providers.tsx` にて `SessionProvider` を全体ラップ
  - `lib/auth.ts` で `session.strategy = 'jwt'`、`maxAge` 設定済み
  - API の保護（例）: `app/api/posts/route.ts` で `auth()` によるセッション確認
- 未ログイン時の表示切り替え
  - `app/page.tsx`（トップ）で `useSession()` により未認証なら `/auth/signin` へ誘導
  - `middleware.ts` は公開パス定義あり（現状は実質パスの振り分けのみ）
- UI/文言
  - Material UI を使用。日本語エラーメッセージ/文言で統一

### 要件との差分（不足/改善ポイント）
1) ルートの整合性
   - 要件: ログインページは `/auth/login`
   - 現状: `/auth/signin` が実装済み
   - 対応: 互換のため `/auth/login` を追加（`/auth/signin` へ内部リダイレクト、または同一コンポーネントの再利用）

2) ログイン後のリダイレクト
   - 現状: 成功時に固定で `/` へ遷移
   - 期待: アクセス元または `callbackUrl`/`next` を考慮して遷移
   - 対応: ログインページで `searchParams` から `callbackUrl`（なければ `next`）を取得し、`signIn` に渡すか成功後に優先適用。未指定時は `/`

3) ヘッダーの表示範囲
   - 現状: `Header` はトップページでのみ表示（`app/page.tsx` 内で使用）
   - 期待: ログイン状態表示は全体で統一
   - 対応: `app/layout.tsx` に `Header` を組み込み、全ページで状態反映（必要に応じて認証系ページでの非表示条件を追加）

4) 未ログイン時の保護と誘導（任意強化）
   - 現状: ページ側（例: トップ）でクライアントリダイレクト。`middleware.ts` は公開/非公開の宣言のみで強制リダイレクトは未実装
   - 対応案: 保護対象ページで SSR もしくは `middleware` による `/auth/signin?callbackUrl=...` への遷移を追加（今回は設計方針として明記、実装は任意）

---

## 仕様詳細（不足分の追補）

### 1. ログインページ ルート追加
- 新規: `app/auth/login/page.tsx`
  - 実装方針A: `redirect('/auth/signin')` で恒久リダイレクト
  - 実装方針B: 既存 `SignInPage` を再利用（コンポーネント再エクスポート）
- 既存: `app/auth/signin/page.tsx` は維持（外部リンク互換のため）

### 2. ログイン後リダイレクト（callbackUrl 対応）
- `app/auth/signin/page.tsx`
  - `useSearchParams()` で `callbackUrl`（なければ `next`）を取得
  - `signIn('credentials', { ..., callbackUrl, redirect: false })`
  - 成功時: `result?.url` または `callbackUrl` に `router.push()`。未指定の場合は `/`
  - 失敗時: 既存の日本語エラー表示を継続

### 3. ヘッダーの全体適用
- `app/layout.tsx`
  - `<Providers>` 配下に `<Header />` を配置し、全ページで状態表示
  - 認証系ページ（`/auth/*`）で非表示にしたい場合は、`Header` 内で `usePathname()` を用いた条件分岐を追加（任意）

### 4. 未ログイン時の保護（任意強化）
- ページ保護の一貫性を高めるオプション（採用は任意）
  - 案A（ページ側 SSR）: 対象ページで `auth()` を用いて未ログインなら `/auth/signin?callbackUrl=...` にサーバーリダイレクト
  - 案B（middleware）: 公開パス以外でセッションが無ければ `/auth/signin?callbackUrl=...` へ遷移（Cookie の可用性とパフォーマンス影響に留意）

---

## 受け入れ基準（Acceptance Criteria）
- `/auth/login` にアクセスした場合もログイン画面に到達できる（`/auth/signin` 互換）
- ログイン成功時、`callbackUrl`（または `next`）が指定されていればそこに遷移し、無ければ `/` に遷移する
- ヘッダーが全ページでログイン状態を反映し、ログアウトボタンで `/auth/signin` に戻る
- 未ログイン時に保護ページを開いた場合、ログイン画面へ誘導される（現状通りでも可、強化案は任意）
- UI とメッセージは現状同様に Material UI と日本語で統一

## テスト観点
- 正しい資格情報でログイン→成功・指定の `callbackUrl` に遷移
- 間違った資格情報→日本語エラー表示、遷移しない
- `/auth/login` 直アクセス→ログイン画面に到達（`/auth/signin` と等価）
- ログアウト→セッション失効し `/auth/signin` に遷移
- ヘッダー表示切替→未ログインで「ログイン/新規登録」、ログイン済みで「ユーザー名/ログアウト」

## 影響範囲・互換性
- 既存の `/auth/signin` は維持しつつ `/auth/login` を追加するため外部リンクの後方互換性を確保
- リダイレクト方針の変更はログイン後 UX の改善に留まり、API 仕様には影響しない


