## 改修仕様書 0813_1（メール認証機能の不足分）

### 目的
既存のメール認証フローに「24時間の有効期限チェック」と「確認メール再送機能」を追加し、要件を満たす。

### 対象範囲（スコープ）
- API: `POST /api/auth/verify-email`（既存・改修）、`POST /api/auth/verify-email/resend`（新規）
- 画面: `GET /auth/verify-email`（既存・改修）
- モデル: `User` スキーマ拡張
- メール: 既存テンプレートの文面は維持（技術的要件を満たすための期限パラメータ追加のみ）

### 現状の実装概要（抜粋）
- 登録時に `verificationToken` を発行し、`/auth/verify-email?token=...` のリンクを送信
- 認証ページでクエリ `token` を取得し `POST /api/auth/verify-email` に送信
- API側でトークン一致ユーザーを検索し、`emailVerified` を設定して有効化
- ログイン時は `emailVerified` 未設定ユーザーを拒否
- 未実装: トークン有効期限チェック、再送機能

### 要件（不足分）
1) 認証トークンの有効期限を24時間に制御
2) 確認メールの再送機能
3) 日本語メッセージでの適切な成否レスポンス
4) セキュリティ・耐久性: トークンの失効・再発行、一時的な濫用防止（簡易レート制御）

---

## 仕様詳細

### 1. データモデル変更（`lib/models/User.ts`）
- 追加フィールド
  - `verificationTokenExpires: Date | null`（デフォルト: `null`）
- 既存フィールド
  - `verificationToken: string | null`
  - `emailVerified: Date | null`

備考:
- 可能であれば将来的に `verificationToken` はハッシュ化保存を推奨（今回は非必須）。
- インデックスは必須ではないが、将来的な検索性のため `verificationToken` に単一インデックスの付与を検討。

### 2. 登録API改修（`POST /api/auth/register`）
- 既存のトークン生成に加え、発行時に `verificationTokenExpires = now + 24h` を設定して保存。
- メール本文は既存テンプレートを流用。期限文言は現状維持（24時間）。

擬似コード:
```
const verificationToken = crypto.randomBytes(32).toString('hex');
const verificationTokenExpires = new Date(Date.now() + 24 * 60 * 60 * 1000);
await User.create({ ..., verificationToken, verificationTokenExpires });
```

### 3. 認証API改修（`POST /api/auth/verify-email`）
- 入力: JSON `{ token: string }`
- 処理:
  - `token` が未提供 → 400: `無効なトークンです`
  - `verificationToken` 一致ユーザーが存在しない → 400: `無効なトークンです`
  - ユーザーの `emailVerified` が既に設定済み → 200: `既に確認済みです。ログインしてください。`
  - 期限チェック: `verificationTokenExpires` が `null` または `Date.now() > verificationTokenExpires` → 400: `トークンの有効期限が切れています。確認メールを再送してください。`
  - 上記を全て満たす場合:
    - `emailVerified = now`
    - `verificationToken = null`
    - `verificationTokenExpires = null`
    - 200: `メールアドレスが確認されました。ログインしてください。`

エラーレスポンス例:
```
{ "error": "トークンの有効期限が切れています。確認メールを再送してください。" }
```

### 4. 再送API新規（`POST /api/auth/verify-email/resend`）
- 目的: 未認証ユーザーに確認メールを再発行・送信
- 入力: JSON `{ email: string }`
- 振る舞い:
  - 入力バリデーション: `email` 必須、形式チェック（簡易で可）
  - ユーザーが存在しない場合でも、常に 200 を返し「送信手続きが完了しました」とする（存在可否を秘匿）
  - ユーザーが存在し、`emailVerified` 未設定の場合のみ内部で再発行:
    - 簡易レート制御（例）: 直近10分以内の再送は拒否（メッセージ: `短時間に複数回のリクエストはできません。しばらくしてからお試しください。`）。
      - 実装案A: `verificationTokenExpires` の上書きログとは別に、`verificationEmailLastSentAt: Date | null` を追加（モデル拡張）
      - 実装案B: IP単位のメモリキャッシュ/ミドルウェアレート制限（今回はモデル拡張のAを推奨）
    - 新規 `verificationToken` を生成し、`verificationTokenExpires = now + 24h` を再設定
    - 確認メール再送
  - レスポンス（常に200）:
    - 成功時メッセージ: `確認メールの再送手続きを受け付けました。メールをご確認ください。`
    - レート超過時メッセージ: `短時間に複数回のリクエストはできません。しばらくしてからお試しください。`

注意:
- セキュリティ上、メールアドレスの存在有無はレスポンスで明示しない。

### 5. 画面改修（`/auth/verify-email`）
- 現状の成功・失敗表示に加え、失敗時（期限切れ）の場合に「確認メールを再送」ボタンを表示し、`POST /api/auth/verify-email/resend` を呼び出す。
- UI: Material UI を継続使用。ボタン押下でスナックバー/アラートに結果メッセージを表示。
- 文言（例）:
  - 成功: `メールアドレスが確認されました。ログインしてください。`
  - 無効: `無効なトークンです`
  - 期限: `トークンの有効期限が切れています。確認メールを再送してください。`
  - 再送成功: `確認メールの再送手続きを受け付けました。メールをご確認ください。`

### 6. メール
- 既存テンプレートを継続使用。リンクは `NEXTAUTH_URL/auth/verify-email?token=...`
- 期限は24時間と明記（既存文言を踏襲）。

### 7. セキュリティ・運用
- トークンは十分長いランダム値（32バイト→hex 64桁）
- 認証成功時は即時無効化（DBからトークンと期限をクリア）
- 再送時は古いトークンを置き換え
- レート制御により濫用を抑止（モデル拡張またはIPベース）
- 将来対応（任意）:
  - `verificationToken` のハッシュ化保存
  - 監査ログ（送信・検証の監査用記録）

### 8. 互換性
- 既存の未認証ユーザーで `verificationTokenExpires` が `null` の場合:
  - 互換方針A（厳格）: `null` は期限切れ扱い → 再送を促す
  - 互換方針B（猶予）: `createdAt + 24h` を暫定期限として扱う
- 本仕様では方針Aを採用（明確に再送フローへ誘導）

### 9. API I/F 定義
- `POST /api/auth/verify-email`
  - Req: `{ token: string }`
  - Res(200): `{ message: string }`
  - Res(400/500): `{ error: string }`

- `POST /api/auth/verify-email/resend`
  - Req: `{ email: string }`
  - Res(200): `{ message: string }`（メール存在有無に関わらず）

### 10. 環境変数
- 既存の SMTP 設定を利用（変更なし）
  - `SMTP_HOST`, `SMTP_PORT`, `SMTP_USER`, `SMTP_PASS`, `EMAIL_FROM`, `NEXTAUTH_URL`

### 11. テスト観点（要自動化）
- 期限内のトークンで成功→`emailVerified` が設定され、トークンがクリアされる
- 期限切れトークンでエラー→再送案内メッセージ
- 無効トークンでエラー
- 再送API:
  - 未認証ユーザーに新規トークン・期限が設定され、メール送信処理が呼ばれる
  - 認証済みユーザーに対しては成功レスポンスだが内部は何もしない
  - 過剰リクエスト（10分以内）でレート制御メッセージ
- UI: 期限切れ時に「確認メールを再送」ボタンが表示され、押下で成功メッセージが表示される

### 12. 実装差分の主な変更点（要約）
- `User` スキーマに `verificationTokenExpires`（必要に応じて `verificationEmailLastSentAt`）を追加
- 登録APIで期限を設定
- 認証APIで期限チェックと既に確認済みの分岐を追加
- 再送APIを新設
- 認証ページに再送ボタンとハンドラを追加

### 13. 受け入れ基準（Acceptance Criteria）
- 24時間有効期限が機能し、期限切れは認証不可となる
- 再送APIが利用でき、未認証ユーザーに新しいリンクが届く
- 画面で成功/失敗/期限切れが日本語で適切に表示される
- 既存の登録・ログインフローは影響なく動作する






